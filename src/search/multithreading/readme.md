TODO: Make the same changes you made in the single threaded versions.